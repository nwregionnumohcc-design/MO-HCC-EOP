<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MO HCC Visualization & Planning Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/SvsTNDyk0Gq1hBdo8="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20n61z9H0W8+iWstIer8j9RdWf6T1L4eNCw5O/W6g0="
        crossorigin=""></script>
    <style>
        /* Custom styles for Leaflet map to ensure it fills the container */
        #map {
            height: 60vh; /* Responsive height for the map */
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* Custom scrollbar for better visual integration */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>

<body class="bg-gray-50 text-gray-800 font-sans">

    <div id="app" class="min-h-screen container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-blue-800 mb-2">
                Missouri HCC Planning Portal
            </h1>
            <p class="text-lg text-gray-600">
                Data Visualization and Strategic Asset Mapping for Healthcare Coalitions
            </p>
        </header>

        <!-- Data Input Section -->
        <section id="data-input" class="bg-white p-6 rounded-xl shadow-lg mb-10">
            <h2 class="text-2xl font-semibold text-blue-700 mb-4 border-b pb-2">1. Load Resource Data</h2>
            <p class="text-gray-600 mb-4">
                Upload **all** your relevant CSV files (e.g., Hospital Report, EMS Report) here. The application will combine and map the resources from every file loaded.
            </p>
            <input type="file" id="csvFile" accept=".csv" multiple class="w-full text-sm text-gray-700
                file:mr-4 file:py-2 file:px-4
                file:rounded-lg file:border-0
                file:text-sm file:font-semibold
                file:bg-blue-50 file:text-blue-700
                hover:file:bg-blue-100" />
            <div id="data-status" class="mt-3 text-sm font-medium text-gray-500">Awaiting file upload...</div>
        </section>

        <!-- Map and Visualization Section -->
        <section id="map-visualization" class="bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold text-blue-700 mb-4 border-b pb-2">2. Scope & Map</h2>

            <!-- Map Container -->
            <div id="map" class="mb-6"></div>

            <!-- Legend and Controls -->
            <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- Legend -->
                <div class="p-3 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="font-bold text-gray-700 mb-2">Legend</h3>
                    <div id="legend" class="text-sm space-y-1">
                        <!-- Legend items will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Control: Toggle Layers -->
                <div class="p-3 bg-gray-50 rounded-lg shadow-inner col-span-2">
                    <h3 class="font-bold text-gray-700 mb-2">Map Layers</h3>
                    <div id="layer-controls" class="grid grid-cols-2 sm:grid-cols-3 gap-2 text-sm">
                        <!-- Checkboxes will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Control: General Info -->
                <div class="p-3 bg-gray-50 rounded-lg shadow-inner">
                    <h3 class="font-bold text-gray-700 mb-2">Data Summary</h3>
                    <p class="text-sm">Total Resources Loaded: <span id="total-resources" class="font-semibold text-blue-600">0</span></p>
                    <p class="text-sm mt-2">Map Center: Missouri (Approx.)</p>
                    <p class="text-xs text-gray-500 mt-1">Zoom and pan to explore specific regions.</p>
                </div>
            </div>
        </section>
    </div>

    <script>
        // Global variables
        let map;
        let resources = [];
        let featureGroups = {}; // Stores Leaflet feature groups for each resource type
        const statusDiv = document.getElementById('data-status');

        // --- Configuration for Resource Types ---
        // This defines the different categories and how to filter the raw data
        const RESOURCE_CATEGORIES = [
            {
                key: 'hospitals',
                label: 'Hospitals & Trauma Centers',
                color: '#EF4444', // Red
                icon: 'hospital',
                filter: (type) => type.includes('Hospital') && !type.includes('Pediatric')
            },
            {
                key: 'pediatricBeds',
                label: 'Pediatric Beds (Hospital)',
                color: '#F97316', // Orange
                icon: 'bed',
                filter: (type) => type.includes('Pediatric')
            },
            {
                key: 'ems',
                label: 'Emergency Services (EMS)',
                color: '#3B82F6', // Blue
                icon: 'ambulance',
                // Matches "EMS Region B Ground Services", "Ambulance Service", etc.
                filter: (type) => type.includes('EMS') || type.includes('Ambulance Service') || type.includes('Emergency Management Agency')
            },
            {
                key: 'localPublicHealth',
                label: 'Local Public Health Agencies (LPHA)',
                color: '#10B981', // Green
                icon: 'syringe',
                filter: (type) => type.includes('LPHA') || type.includes('Health Department')
            },
            {
                key: 'federallyQualifiedHealth',
                label: 'FQHCs / Rural Health Clinics',
                color: '#6366F1', // Indigo
                icon: 'clinic-medical',
                filter: (type) => type.includes('FQHC') || type.includes('Rural Health Clinic')
            },
            {
                key: 'otherAssets',
                label: 'Other Strategic Assets',
                color: '#6B7280', // Gray (Catch-all)
                icon: 'project-diagram',
                filter: (type) => !(
                    type.includes('Hospital') ||
                    type.includes('Pediatric') ||
                    type.includes('LPHA') ||
                    type.includes('Health Department') ||
                    type.includes('FQHC') ||
                    type.includes('Rural Health Clinic') ||
                    type.includes('EMS') ||
                    type.includes('Ambulance Service') ||
                    type.includes('Emergency Management Agency')
                )
            },
        ];

        // Function to initialize the map
        function initMap() {
            // Check if map is already initialized
            if (map) {
                map.remove();
            }

            // Missouri center coordinates: [38.5739, -92.6038]
            map = L.map('map').setView([38.5739, -92.6038], 7);

            // Base Tile Layer (OpenStreetMap)
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
            }).addTo(map);

            // Initialize all feature groups
            RESOURCE_CATEGORIES.forEach(category => {
                featureGroups[category.key] = L.featureGroup().addTo(map);
            });

            // Populate Legend and Controls
            populateLegend();
            populateLayerControls();
        }

        // Function to generate and populate the map legend
        function populateLegend() {
            const legendDiv = document.getElementById('legend');
            legendDiv.innerHTML = ''; // Clear existing content

            RESOURCE_CATEGORIES.forEach(category => {
                const item = document.createElement('div');
                item.className = 'flex items-center space-x-2';
                item.innerHTML = `
                    <span style="background-color: ${category.color};" class="w-3 h-3 rounded-full flex-shrink-0 border border-gray-400"></span>
                    <span>${category.label}</span>
                `;
                legendDiv.appendChild(item);
            });
        }

        // Function to create checkboxes for map layer controls
        function populateLayerControls() {
            const controlsDiv = document.getElementById('layer-controls');
            controlsDiv.innerHTML = ''; // Clear existing content

            RESOURCE_CATEGORIES.forEach(category => {
                const label = document.createElement('label');
                label.className = 'inline-flex items-center cursor-pointer p-1 rounded-md hover:bg-blue-50 transition duration-150';
                label.innerHTML = `
                    <input type="checkbox" checked id="toggle-${category.key}" data-key="${category.key}" class="form-checkbox h-4 w-4 text-blue-600 rounded-sm border-gray-300 focus:ring-blue-500">
                    <span class="ml-2 text-gray-700 font-medium">${category.label}</span>
                `;
                controlsDiv.appendChild(label);

                // Add event listener to toggle visibility
                document.getElementById(`toggle-${category.key}`).addEventListener('change', (e) => {
                    toggleLayer(e.target.dataset.key, e.target.checked);
                });
            });
        }

        // Function to toggle map layer visibility
        function toggleLayer(key, isVisible) {
            const group = featureGroups[key];
            if (!group) return;

            if (isVisible) {
                map.addLayer(group);
            } else {
                map.removeLayer(group);
            }
        }

        // Function to parse the uploaded CSV file
        function parseCSV(text) {
            // Simple split by newline, then split by comma for basic parsing
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length <= 1) return [];

            // Get the header (first line)
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

            const data = [];
            // Process the remaining lines
            for (let i = 1; i < lines.length; i++) {
                // Use a simple regex to handle commas inside quotes, which is common in CSVs
                const values = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);

                if (!values || values.length !== headers.length) {
                    // console.warn(`Skipping malformed row ${i + 1}: ${lines[i]}`);
                    continue; // Skip malformed rows
                }

                let row = {};
                for (let j = 0; j < headers.length; j++) {
                    // Clean up values (remove surrounding quotes)
                    let value = values[j].trim().replace(/"/g, '');
                    row[headers[j]] = value;
                }
                data.push(row);
            }
            return data;
        }

        /**
         * Function to process data from all files and add markers to the map.
         * @param {Array<Object>} data - Array of all merged resource objects.
         */
        function processData(data) {
            resources = data.filter(r => r.Latitude && r.Longitude && r.Type);
            document.getElementById('total-resources').textContent = resources.length;

            // Clear all existing feature groups
            Object.values(featureGroups).forEach(group => group.clearLayers());

            let bounds = []; // To fit the map view to the loaded data

            resources.forEach(resource => {
                const lat = parseFloat(resource.Latitude);
                const lng = parseFloat(resource.Longitude);
                const resourceType = resource.Type || 'Unknown';
                const resourceName = resource['Resource Name'] || 'Unnamed Resource';
                const address = `${resource['Street Address']}, ${resource.City}, ${resource.State} ${resource.ZIP}`;
                const county = resource.County || 'N/A';
                // Use a combination of common phone column names
                const phone = resource['Phone 1'] || resource['Phone'] || 'N/A';
                // Use a combination of common designation column names
                const trauma = resource['Trauma Level Designation'] || resource['Level Designation'] || 'N/A';
                
                if (isNaN(lat) || isNaN(lng) || lat === 0 || lng === 0) {
                    // Skip resources without valid coordinates
                    return;
                }
                
                bounds.push([lat, lng]);

                // Determine the category for the resource
                const category = RESOURCE_CATEGORIES.find(c => c.filter(resourceType));
                // Fallback to 'Other Strategic Assets' if no explicit filter matches, should not happen with current logic
                if (!category) {
                     return;
                }

                const markerColor = category.color;
                const iconClass = category.icon;

                // Create a custom HTML icon for Leaflet
                const customIcon = L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style="color:${markerColor}; font-size: 24px;">
                                <i class="fa fa-${iconClass}" title="${category.label}"></i>
                           </div>`,
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                });

                // Create the popup content
                const popupContent = `
                    <div class="p-2 text-sm font-sans" style="max-width: 300px;">
                        <h4 class="font-bold text-base text-blue-800 mb-1">${resourceName}</h4>
                        <p class="text-xs font-semibold text-gray-700 mb-1">${category.label}</p>
                        <p><strong>Address:</strong> ${address}</p>
                        <p><strong>County:</strong> ${county}</p>
                        ${phone !== 'N/A' ? `<p><strong>Phone:</strong> <a href="tel:${phone}" class="text-blue-500 hover:underline">${phone}</a></p>` : ''}
                        ${trauma !== 'N/A' && trauma !== '--' ? `<p><strong>Designation:</strong> <span class="font-semibold text-red-600">${trauma}</span></p>` : ''}
                    </div>
                `;

                // Create the marker and add it to the correct feature group
                const marker = L.marker([lat, lng], { icon: customIcon })
                                .bindPopup(popupContent);

                featureGroups[category.key].addLayer(marker);
            });

            // Adjust map view to fit all loaded markers
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        }
        
        /**
         * Handles loading and parsing of multiple files selected by the user.
         * @param {FileList} files - The list of files to process.
         */
        function loadAndProcessFiles(files) {
            let allCombinedResources = [];
            let filesProcessed = 0;
            const totalFiles = files.length;
            statusDiv.textContent = `Loading ${totalFiles} file(s)...`;
            
            // Loop through each file and read its contents asynchronously
            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const csvText = e.target.result;
                        const parsedData = parseCSV(csvText);

                        if (parsedData.length > 0) {
                            allCombinedResources.push(...parsedData);
                        }
                    } catch (error) {
                        console.error(`Error processing file ${file.name}:`, error);
                    } finally {
                        filesProcessed++;
                        // Check if all files are processed
                        if (filesProcessed === totalFiles) {
                            resources = allCombinedResources;
                            if (resources.length > 0) {
                                processData(resources);
                                statusDiv.innerHTML = `<span class="text-green-600">Successfully loaded ${resources.length} total records from ${totalFiles} file(s).</span> Check the map layers to visualize data.`;
                            } else {
                                statusDiv.textContent = 'Error: No valid data found in the uploaded files.';
                            }
                        }
                    }
                };

                reader.onerror = function() {
                    filesProcessed++;
                    console.error(`Error reading file ${file.name}`);
                    if (filesProcessed === totalFiles) {
                        statusDiv.textContent = `Completed processing, but encountered errors reading files. Total records loaded: ${allCombinedResources.length}.`;
                    }
                };

                reader.readAsText(file);
            });
        }


        // --- Event Listener and Initialization ---

        document.addEventListener('DOMContentLoaded', () => {
            // Inject Font Awesome for icons
            const faScript = document.createElement('script');
            faScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/js/all.min.js';
            faScript.crossOrigin = 'anonymous';
            document.head.appendChild(faScript);

            // Initialize the map
            initMap();

            const fileInput = document.getElementById('csvFile');

            fileInput.addEventListener('change', (event) => {
                const files = event.target.files;
                if (files.length === 0) {
                    statusDiv.textContent = 'Awaiting file upload...';
                    return;
                }

                loadAndProcessFiles(files);
            });
        });
    </script>
</body>
</html>
