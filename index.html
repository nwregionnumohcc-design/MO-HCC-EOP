<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCC Resource Data Merger</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Papa Parse for CSV handling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        /* Custom styles for better look and feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .file-input-label {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .file-input-label:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen p-4 sm:p-8 flex justify-center">
        <div class="w-full max-w-4xl space-y-8">
            
            <header class="text-center">
                <h1 class="text-3xl font-bold text-gray-800">Missouri HCC Resource Data Merger</h1>
                <p class="text-gray-500 mt-1">Combine Hospital/LPHA and EMS resource datasets (V2: Auto-skips top header row).</p>
            </header>

            <!-- Status and Messaging -->
            <div id="status-message" class="p-4 rounded-lg text-sm hidden" role="alert"></div>

            <!-- 1. File Upload Section -->
            <section class="container-card bg-white p-6 rounded-xl">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">1. Load Resource Data</h2>
                <p class="text-gray-600 mb-4">
                    Please select **both** the Hospital/LPHA/FQHC and the EMS CSV files simultaneously. The application will analyze and combine them, automatically skipping the initial report title row.
                </p>
                <input 
                    type="file" 
                    id="file-input" 
                    accept=".csv" 
                    multiple 
                    class="hidden"
                    onchange="handleFiles(event.target.files)"
                >
                <label for="file-input" class="file-input-label inline-flex items-center justify-center w-full sm:w-auto px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5.002 5.002 0 0112 5c.705 0 1.378.163 2 .451v.001c.71.272 1.346.685 1.88 1.25l.896 1.054A2.001 2.001 0 0017 9.5v5c0 1.104-.896 2-2 2h-4v2h4a4 4 0 000-8h-.5a.5.5 0 01-.5-.5V8.5a.5.5 0 01.5-.5H15a3 3 0 013 3v3.5a1 1 0 002 0v-3.5a5.002 5.002 0 00-4-4.899v-.001a4.002 4.002 0 00-6.88 2.053v.002A4 4 0 107 16z"></path></svg>
                    Choose Files (Select 2 CSVs)
                </label>
                <ul id="file-list" class="mt-4 space-y-2 text-sm text-gray-600">
                    <!-- Loaded files will appear here -->
                </ul>
            </section>

            <!-- 2. Combined Data Summary and Download -->
            <section id="results-section" class="container-card bg-white p-6 rounded-xl hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 border-b pb-2">2. Combined Data Results</h2>
                
                <p id="combined-count" class="text-lg font-medium text-gray-800 mb-4">
                    <span class="font-bold text-indigo-600" id="total-resources">0</span> Total Resources Combined.
                </p>
                
                <button 
                    id="download-button" 
                    onclick="downloadCSV()" 
                    class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out"
                >
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Download Combined CSV
                </button>
                <div class="mt-4 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                    <h3 class="font-semibold text-gray-700 mb-2">Preview of Combined Data Headers:</h3>
                    <code id="header-preview" class="text-xs text-gray-600 break-words"></code>
                </div>
            </section>
        </div>
    </div>

    <script type="module">
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let combinedData = [];

        // --- Firebase Setup (Standard for Canvas Environment, not strictly needed for CSV utility but good practice) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        let db, auth;

        async function initFirebase() {
            if (!firebaseConfig) {
                console.warn("Firebase configuration not available. Running in local mode.");
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                console.log("Firebase initialized and user signed in:", auth.currentUser.uid);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                displayStatus('error', 'Authentication failed. Data processing functionality may be limited.');
            }
        }

        // Initialize Firebase on load
        initFirebase();

        // --- UI Utility Functions ---

        /**
         * Displays a status message to the user.
         * @param {'success' | 'error' | 'info'} type The type of message.
         * @param {string} message The message content.
         */
        function displayStatus(type, message) {
            const statusEl = document.getElementById('status-message');
            statusEl.textContent = message;
            statusEl.className = 'p-4 rounded-lg text-sm transition-all duration-300';
            statusEl.classList.remove('hidden');

            const classes = {
                success: 'bg-green-100 text-green-800 border border-green-300',
                error: 'bg-red-100 text-red-800 border border-red-300',
                info: 'bg-blue-100 text-blue-800 border border-blue-300'
            };

            statusEl.classList.add(...classes[type].split(' '));
            // Keep error messages visible longer
            const duration = type === 'error' ? 15000 : 8000;
            setTimeout(() => statusEl.classList.add('hidden'), duration); 
        }

        /**
         * Clears all temporary UI state.
         */
        function clearUI() {
            document.getElementById('file-list').innerHTML = '';
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('total-resources').textContent = '0';
            document.getElementById('header-preview').textContent = '';
            document.getElementById('status-message').classList.add('hidden');
        }
        
        // --- Data Processing Functions ---

        /**
         * Parses the column headers to a standard set.
         * @param {string} header The original header string.
         * @returns {string} The standardized header key.
         */
        function standardizeHeader(header) {
            if (!header) return '';
            const normalized = header.toLowerCase().trim();
            // Core identifiers
            if (normalized.includes('resource name')) return 'Resource Name';
            if (normalized.includes('type')) return 'Type';
            if (normalized.includes('street address')) return 'Street Address';
            if (normalized.includes('city')) return 'City';
            if (normalized.includes('state')) return 'State';
            if (normalized.includes('zip')) return 'ZIP';
            if (normalized.includes('county')) return 'County';
            
            // Location/Contact
            if (normalized.includes('latitude')) return 'Latitude';
            if (normalized.includes('longitude')) return 'Longitude';
            if (normalized.includes('phone 1')) return 'Phone 1';
            
            // Resource-specific
            if (normalized.includes('trauma level designation')) return 'Trauma Designation';
            if (normalized.includes('contact')) return 'Contact'; // For EMS
            
            return header.trim(); // Keep unknown headers
        }

        /**
         * Processes the uploaded files.
         * @param {FileList} files 
         */
        window.handleFiles = function(files) {
            clearUI();
            combinedData = [];
            const fileListEl = document.getElementById('file-list');
            
            if (files.length === 0) {
                displayStatus('info', 'No files selected.');
                return;
            }
            
            // Filter out non-CSV files just in case the accept=".csv" is bypassed
            const csvFiles = Array.from(files).filter(file => file.name.toLowerCase().endsWith('.csv'));
            
            if (csvFiles.length === 0) {
                displayStatus('error', 'No CSV files were selected. Please select files with the .csv extension.');
                return;
            }

            if (csvFiles.length > 2) {
                displayStatus('error', 'Please select a maximum of two CSV files (one Hospital/LPHA and one EMS).');
                return;
            }

            let filesProcessed = 0;
            const expectedCount = csvFiles.length;
            
            csvFiles.forEach((file) => {
                const li = document.createElement('li');
                li.id = `status-${file.name.replace(/\s/g, '-')}`;
                li.textContent = `Loading: ${file.name}...`;
                fileListEl.appendChild(li);

                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false,
                    // *** CRITICAL CHANGE: Tell Papa Parse to skip the first row, 
                    // which appears to be a report title row in the uploaded data snippets. ***
                    beforeFirstChunk: (chunk) => {
                        const lines = chunk.split('\n');
                        // If the first line is the report title, remove it
                        if (lines[0].includes('Resource Detail Report for: Missouri')) {
                             return lines.slice(1).join('\n');
                        }
                        return chunk; // Return chunk unchanged if the title line is not found
                    },
                    complete: (results) => {
                        filesProcessed++;
                        const statusIndicator = document.getElementById(`status-${file.name.replace(/\s/g, '-')}`);
                        
                        // 1. Rename headers to standard format and process rows
                        const standardizedData = results.data.map(row => {
                            const newRow = {};
                            let hasType = false;
                            for (const oldHeader in row) {
                                const newHeader = standardizeHeader(oldHeader);
                                if (newHeader) {
                                    newRow[newHeader] = row[oldHeader];
                                    if (newHeader === 'Type') hasType = true;
                                }
                            }
                            
                            // 2. Infer 'Type' if missing
                            if (!hasType) {
                                const fileNameLower = file.name.toLowerCase();
                                if (fileNameLower.includes('ems')) {
                                    newRow['Type'] = 'EMS Resource (Inferred)';
                                } else if (fileNameLower.includes('hospital') || fileNameLower.includes('lpha')) {
                                    newRow['Type'] = 'HCC Resource (Inferred)';
                                } else {
                                    newRow['Type'] = 'Resource (Unknown)';
                                }
                            }
                            return newRow;
                        }).filter(row => row['Resource Name'] && row['Resource Name'].trim() !== ''); // Filter out empty rows

                        if (standardizedData.length === 0) {
                             statusIndicator.textContent = `Error: ${file.name} - Could not parse or file is empty.`;
                             statusIndicator.classList.add('text-red-500');
                             return;
                        }

                        // 3. Add to combined data
                        combinedData.push(...standardizedData);
                        
                        statusIndicator.textContent = `Success: ${file.name} loaded with ${standardizedData.length} records.`;
                        statusIndicator.classList.add('text-green-500');

                        // 4. Check if all files are processed
                        if (filesProcessed === expectedCount) {
                            processCombinedData();
                        }
                    },
                    error: (error) => {
                        filesProcessed++;
                        const statusIndicator = document.getElementById(`status-${file.name.replace(/\s/g, '-')}`);
                        statusIndicator.textContent = `Error: ${file.name} failed to parse (${error.message}).`;
                        statusIndicator.classList.add('text-red-500');

                        if (filesProcessed === expectedCount) {
                            processCombinedData();
                        }
                    }
                });
            });
        };

        /**
         * Finalizes the combined data and updates the results section.
         */
        function processCombinedData() {
            if (combinedData.length === 0) {
                displayStatus('error', 'No valid data was loaded from the files. Please check the file formats and ensure they are standard CSV files.');
                return;
            }

            // Identify all unique headers from the combined dataset
            const allHeaders = new Set();
            combinedData.forEach(row => {
                Object.keys(row).forEach(header => allHeaders.add(header));
            });
            
            // Set a consistent order for the core headers
            const coreHeadersOrder = [
                'Resource Name', 'Type', 'County', 'Street Address', 'City', 'State', 'ZIP',
                'Latitude', 'Longitude', 
                'Phone 1', 'Contact', 'Trauma Designation'
            ];
            
            // Finalize the header array
            const finalHeaders = [];
            coreHeadersOrder.forEach(h => {
                if (allHeaders.has(h)) {
                    finalHeaders.push(h);
                    allHeaders.delete(h);
                }
            });
            // Add any remaining unique headers that were not in the core list
            Array.from(allHeaders).sort().forEach(h => finalHeaders.push(h));


            // Ensure every row has all columns (with empty string for missing values)
            combinedData = combinedData.map(row => {
                const standardizedRow = {};
                finalHeaders.forEach(header => {
                    standardizedRow[header] = row[header] || '';
                });
                return standardizedRow;
            });

            // Update UI
            document.getElementById('total-resources').textContent = combinedData.length;
            document.getElementById('header-preview').textContent = finalHeaders.join(' | ');
            document.getElementById('results-section').classList.remove('hidden');
            displayStatus('success', `Successfully combined ${combinedData.length} records into a single, standardized dataset!`);
        }

        /**
         * Downloads the combined data as a CSV file.
         */
        window.downloadCSV = function() {
            if (combinedData.length === 0) {
                displayStatus('error', 'No data to download. Please load files first.');
                return;
            }

            const csv = Papa.unparse(combinedData, {
                quotes: true,
                delimiter: ",",
                header: true,
                newline: "\r\n"
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", "Combined_HCC_Resource_Data_V2.csv");
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            displayStatus('info', 'Download initiated!');
        }
    </script>
</body>
</html>
